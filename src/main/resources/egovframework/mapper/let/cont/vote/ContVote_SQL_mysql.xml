<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ContVoteManageDAO">

	<resultMap id="boardList" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="inqireCo" column="RDCNT"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="replyAt" column="ANSWER_AT"/>		
		<result property="replyLc" column="ANSWER_LC"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="ntceBgnde" column="NTCE_BGNDE"/>
		<result property="ntceEndde" column="NTCE_ENDDE"/>
	</resultMap>

	<resultMap id="boardDetail" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>	
		<result property="ntcrId" column="NTCR_ID"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="nttNo" column="NTT_NO"/>
		<result property="nttCn" column="NTT_CN"/>
		<result property="password" column="PASSWORD"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="ntceBgnde" column="NTCE_BGNDE"/>
		<result property="ntceEndde" column="NTCE_ENDDE"/>
		<result property="inqireCo" column="RDCNT"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="replyAt" column="ANSWER_AT"/>		
		<result property="replyLc" column="ANSWER_LC"/>
		<result property="sortOrdr" column="SORT_ORDR"/>
		<result property="bbsTyCode" column="BBS_TY_CODE"/>
		<result property="bbsAttrbCode" column="BBS_ATTRB_CODE"/>
		<result property="replyPosblAt" column="REPLY_POSBL_AT"/>
		<result property="fileAtchPosblAt" column="FILE_ATCH_POSBL_AT"/>
		<result property="posblAtchFileNumber" column="ATCH_POSBL_FILE_NUMBER"/>
		<result property="bbsNm" column="BBS_NM"/>
	</resultMap>

	<resultMap id="sortList" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="sortOrdr" column="SORT_ORDR"/>
		<result property="parnts" column="PARNTSCTT_NO"/>
		<result property="nttNo" column="NTT_NO"/>		
		<result property="replyLc" column="ANSWER_LC"/>
	</resultMap>

	<resultMap id="guestList" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="password" column="PASSWORD"/>
		<result property="frstRegisterPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="nttCn" column="NTT_CN"/>
		<result property="useAt" column="USE_AT"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
	</resultMap>

	<resultMap id="groupList" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="valtMngmNo" column="VALT_MNGM_NO"/>
		<result property="valtMngmTtl" column="VALT_MNGM_TTL"/>
		<result property="useAt" column="USE_AT"/>
	</resultMap>

	<resultMap id="bbsList" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="valtMngmNo" column="VALT_MNGM_NO"/>
		<result property="valtMngmTtl" column="VALT_MNGM_TTL"/>
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="ntcrNm" column="NTCR_NM"/>
		<result property="useAt" column="USE_AT"/>
	</resultMap>

	<resultMap id="voteList" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="valtMngmNo" column="VALT_MNGM_NO"/>
		<result property="valtQsitMnno" column="VALT_QSIT_MNNO"/>
		<result property="qsitNo" column="QSIT_NO"/>
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="exmnId" column="EXMN_ID"/>
		<result property="valtScr" column="VALT_SCR"/>
		<result property="useAt" column="USE_AT"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="lastUpdusrPnttm" column="LAST_UPDT_PNTTM"/>
		<result property="lastUpdusrId" column="LAST_UPDUSR_ID"/>
	</resultMap>

	<resultMap id="voteRlstList" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="valtMngmNo" column="VALT_MNGM_NO"/>
		<result property="valtQsitMnno" column="VALT_QSIT_MNNO"/>
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="exmnId" column="EXMN_ID"/>
		<result property="exmnNm" column="EXMN_NM"/>
		<result property="sumScr" column="SUM_SCR"/>
		<result property="valtOpnn" column="VALT_OPNN"/>
		<result property="useAt" column="USE_AT"/>
		<result property="frstRegisterNm" column="FRST_REGISTER_NM"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="lastUpdusrPnttm" column="LAST_UPDT_PNTTM"/>
		<result property="lastUpdusrId" column="LAST_UPDUSR_ID"/>
	</resultMap>

	<resultMap id="voteRankList" type="egovframework.let.cont.vote.service.ContVoteVO">
		<result property="valtMngmNo" column="VALT_MNGM_NO"/>
		<result property="valtQsitMnno" column="VALT_QSIT_MNNO"/>
		<result property="bbsId" column="BBS_ID"/>
		<result property="nttId" column="NTT_ID"/>
		<result property="useAt" column="USE_AT"/>
		<result property="sumScr" column="SUM_SCR"/>
		<result property="avgScr" column="AVG_SCR"/>
		<result property="valtCnt" column="VALT_CNT"/>
		<result property="totScrRank" column="TOT_SCR_RANK"/>
		<result property="avgScrRank" column="AVG_SCR_RANK"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
		<result property="nttSj" column="NTT_SJ"/>
		<result property="teamNm" column="TEAM_NM"/>
		<result property="selectImg" column="SELECT_IMG"/>
		<result property="imgUrl" column="IMG_URL"/>
		<result property="nttId" column="USER_ID"/>
		<result property="ntcrNm" column="USER_NM"/>
	</resultMap>

	<select id="selectContVoteAdminGroupList" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultMap="groupList">

		select distinct a.VALT_MNGM_NO as VALT_MNGM_NO , a.TTL as VALT_MNGM_TTL
		FROM tb_valt_mngm_master a
				 LEFT JOIN tb_exmn_mngm b ON a.VALT_MNGM_NO = b.VALT_MNGM_NO
				 LEFT JOIN tb_valt_tar_mngm c ON a.VALT_MNGM_NO = c.VALT_MNGM_NO
		where 1=1
		<if test="exmnId != 'admin'">
			AND b.EXMN_ID = #{exmnId}
		</if>
		and a.USE_AT = 'Y'
		order by a.VALT_MNGM_NO
						
	</select>

	<select id="selectContVoteAdminGroupListCnt" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultType="java.lang.Integer">

		select count( distinct a.VALT_MNGM_NO, a.TTL ) as cnt
		FROM tb_valt_mngm_master a
		LEFT JOIN tb_exmn_mngm b ON a.VALT_MNGM_NO = b.VALT_MNGM_NO
		LEFT JOIN tb_valt_tar_mngm c ON a.VALT_MNGM_NO = c.VALT_MNGM_NO
		where 1=1
		<if test="exmnId != 'admin'">
		   AND b.EXMN_ID = #{exmnId}
		</if>
		and a.USE_AT = 'Y'
		order by a.VALT_MNGM_NO

	</select>

	<select id="selectContVoteAdminBBSList" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultMap="bbsList">

		select a.VALT_MNGM_NO as VALT_MNGM_NO, a.VALT_QSIT_MNNO as VALT_QSIT_MNNO, a.TTL as VALT_MNGM_TTL, c.NTT_ID as NTT_ID, c.BBS_ID as BBS_ID, user.USER_NM AS NTCR_NM
		FROM tb_valt_mngm_master a
				 LEFT JOIN tb_exmn_mngm b ON a.VALT_MNGM_NO = b.VALT_MNGM_NO
				 LEFT JOIN tb_valt_tar_mngm c ON a.VALT_MNGM_NO = c.VALT_MNGM_NO

				 LEFT OUTER JOIN lettnbbs bbs on c.NTT_ID = bbs.NTT_ID and c.BBS_ID = bbs.BBS_ID
				 LEFT OUTER JOIN comvnusermaster user on user.ESNTL_ID = bbs.FRST_REGISTER_ID

		where b.EXMN_ID = #{exmnId}
		  and a.VALT_MNGM_NO = #{valtMngmNo}
		  and a.USE_AT = 'Y'
		order by a.VALT_MNGM_NO


	</select>

	<select id="selectContVoteAdminBBSListCnt" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultType="java.lang.Integer">

		select count( 1 ) as cnt
		FROM tb_valt_mngm_master a
				 LEFT JOIN tb_exmn_mngm b ON a.VALT_MNGM_NO = b.VALT_MNGM_NO
				 LEFT JOIN tb_valt_tar_mngm c ON a.VALT_MNGM_NO = c.VALT_MNGM_NO

				 LEFT OUTER JOIN lettnbbs bbs on c.NTT_ID = bbs.NTT_ID and c.BBS_ID = bbs.BBS_ID
				 LEFT OUTER JOIN comvnusermaster user on user.ESNTL_ID = bbs.FRST_REGISTER_ID

		where b.EXMN_ID = #{exmnId}
		  and a.VALT_MNGM_NO = #{valtMngmNo}
		  and a.USE_AT = 'Y'

	</select>

	<select id="selectAdminVotesList" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultMap="voteList">

		SELECT a.VALT_MNGM_NO as VALT_MNGM_NO
		     , a.VALT_QSIT_MNNO as VALT_QSIT_MNNO
			 , a.QSIT_NO as QSIT_NO
			 , a.NTT_ID as NTT_ID
			 , a.BBS_ID as BBS_ID
			 , a.EXMN_ID as EXMN_ID
			 , a.VALT_SCR as VALT_SCR
			 , a.USE_AT as USE_AT
		FROM tb_valt_scr a
		LEFT JOIN tb_valt_mngm_master b ON a.VALT_MNGM_NO = b.VALT_MNGM_NO AND a.VALT_QSIT_MNNO = b.VALT_QSIT_MNNO
		WHERE b.VALT_MNGM_NO = #{valtMngmNo}
		  AND a.NTT_ID = #{nttId}
		  AND a.BBS_ID = #{bbsId}
		  AND a.EXMN_ID = #{exmnId}
		ORDER BY a.VALT_QSIT_MNNO, a.QSIT_NO



	</select>

	<select id="selectAdminVotesCnt" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultType="java.lang.Integer">

		SELECT count(1) as cnt
		FROM tb_valt_scr a
		LEFT JOIN tb_valt_mngm_master b ON a.VALT_MNGM_NO = b.VALT_MNGM_NO AND a.VALT_QSIT_MNNO = b.VALT_QSIT_MNNO
		WHERE b.VALT_MNGM_NO = #{valtMngmNo}
		  AND a.NTT_ID = #{nttId}
		  AND a.BBS_ID = #{bbsId}
		  AND a.EXMN_ID = #{exmnId}

	</select>

	<select id="selectAdminVoteRsltsList" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultMap="voteRlstList">

		SELECT a.VALT_MNGM_NO as VALT_MNGM_NO
			 , a.VALT_QSIT_MNNO as VALT_QSIT_MNNO
			 , a.NTT_ID as NTT_ID
			 , a.BBS_ID as BBS_ID
			 , a.EXMN_ID as EXMN_ID
			 , a.SUM_SCR as SUM_SCR
			 , a.VALT_OPNN as VALT_OPNN
			 , user.USER_NM as EXMN_NM
		FROM tb_valt_sta a
        LEFT JOIN comvnusermaster user on a.EXMN_ID = user.USER_ID
		WHERE a.VALT_MNGM_NO = #{valtMngmNo}
		AND a.VALT_QSIT_MNNO = #{valtQsitMnno}
		AND a.NTT_ID = #{nttId}
		AND a.BBS_ID = #{bbsId}
		ORDER BY user.RANK_CODE, user.USER_NM

	</select>

	<select id="selectAdminVoteRsltsCnt" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultType="java.lang.Integer">

		SELECT count(1) as cnt
		FROM tb_valt_sta a
		LEFT JOIN comvnusermaster user on a.EXMN_ID = user.USER_ID
		WHERE a.VALT_MNGM_NO = #{valtMngmNo}
		  AND a.VALT_QSIT_MNNO = #{valtQsitMnno}
		  AND a.NTT_ID = #{nttId}
		  AND a.BBS_ID = #{bbsId}

	</select>

	<select id="selectAdminVoteCnt" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultType="java.lang.Integer">

		SELECT count(1) as cnt
		FROM tb_valt_scr a
		LEFT JOIN tb_valt_mngm_master b ON a.VALT_MNGM_NO = b.VALT_MNGM_NO AND a.VALT_QSIT_MNNO = b.VALT_QSIT_MNNO
		WHERE b.VALT_MNGM_NO = #{valtMngmNo}
		  AND a.NTT_ID = #{nttId}
		  AND a.BBS_ID = #{bbsId}
		  AND a.EXMN_ID = #{exmnId}
		  AND a.QSIT_NO = #{qsitNo}

	</select>

	<insert id="insertAdminVote" parameterType="egovframework.let.cont.vote.service.ContVoteVO">

		INSERT INTO tb_valt_scr (VALT_MNGM_NO, VALT_QSIT_MNNO, QSIT_NO, NTT_ID, BBS_ID, EXMN_ID, VALT_SCR, USE_AT, FRST_REGIST_PNTTM, FRST_REGISTER_ID)
		VALUES (#{valtMngmNo}, #{valtQsitMnno}, #{qsitNo}, #{nttId}, #{bbsId}, #{exmnId}, #{valtScr}, #{useAt}, SYSDATE(), #{frstRegisterId})
			ON DUPLICATE KEY UPDATE
			VALT_SCR = VALUES(VALT_SCR),
			LAST_UPDT_PNTTM = SYSDATE(),
			LAST_UPDUSR_ID = VALUES(EXMN_ID)

	</insert>

	<insert id="insertVoteScore" parameterType="egovframework.let.cont.vote.service.ContVoteVO">

		INSERT INTO lettnbbsscore (NTT_ID, BBS_ID, WRTER_ID, SCORE, USE_AT, FRST_REGIST_PNTTM, FRST_REGISTER_ID)
		VALUES (#{nttId}, #{bbsId}, #{exmnId}, #{score}, #{useAt}, SYSDATE(), #{frstRegisterId})
			ON DUPLICATE KEY UPDATE
            SCORE = VALUES(SCORE),
            LAST_UPDT_PNTTM = SYSDATE(),
            LAST_UPDUSR_ID = VALUES(FRST_REGISTER_ID)

	</insert>

	<select id="selectVoteScore" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultType="java.lang.Integer">

		SELECT IFNULL((
			SELECT score
			FROM lettnbbsscore
			WHERE NTT_ID = #{nttId}
			  AND BBS_ID = #{bbsId}
			  AND WRTER_ID = #{exmnId}
			  AND USE_AT = 'Y'
			LIMIT 1
				   ), 0) AS score

	</select>

	<insert id="insertAdminValtSta" parameterType="egovframework.let.cont.vote.service.ContVoteVO">
		<selectKey keyProperty="sumScr" resultType="java.lang.String" order="BEFORE">
			select IFNULL(SUM(VALT_SCR),0) as VALT_SCR from tb_valt_scr
            where VALT_MNGM_NO = #{valtMngmNo} and VALT_QSIT_MNNO = #{valtQsitMnno} and NTT_ID = #{nttId} and BBS_ID = #{bbsId} and EXMN_ID = #{exmnId} and USE_AT = 'Y'
		</selectKey>
		INSERT INTO tb_valt_sta (VALT_MNGM_NO, VALT_QSIT_MNNO, NTT_ID, BBS_ID, EXMN_ID, SUM_SCR, USE_AT, FRST_REGIST_PNTTM, FRST_REGISTER_ID, VALT_OPNN)
		VALUES (#{valtMngmNo}, #{valtQsitMnno}, #{nttId}, #{bbsId}, #{exmnId}, #{sumScr}, #{useAt}, SYSDATE(), #{frstRegisterId}, #{valtOpnn})
			ON DUPLICATE KEY UPDATE
			SUM_SCR = VALUES(SUM_SCR),
			VALT_OPNN = VALUES(VALT_OPNN),
			USE_AT = VALUES(USE_AT),
			LAST_UPDT_PNTTM = SYSDATE(),
			LAST_UPDUSR_ID = VALUES(FRST_REGISTER_ID)

	</insert>

	<select id="selectVoteValtOpnn" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultType="java.lang.String">
		select VALT_OPNN from tb_valt_sta
		where VALT_MNGM_NO = #{valtMngmNo} and VALT_QSIT_MNNO = #{valtQsitMnno} and NTT_ID = #{nttId} and BBS_ID = #{bbsId} and EXMN_ID = #{exmnId} and USE_AT = 'Y'
	</select>

	<select id="selectContVoteRankList" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultMap="voteRankList">

		SELECT
			r.VALT_MNGM_NO AS VALT_MNGM_NO,
			r.VALT_QSIT_MNNO AS VALT_QSIT_MNNO,
			r.NTT_ID AS NTT_ID,
			r.BBS_ID AS BBS_ID,
			r.TOTAL_SCORE AS SUM_SCR,
			r.AVG_SCORE AS AVG_SCR,
			r.VALT_CNT AS VALT_CNT,
			r.TOTAL_SCORE_RANK AS TOT_SCR_RANK,
			r.AVG_SCORE_RANK AS AVG_SCR_RANK,
			bbs.FRST_REGISTER_ID AS FRST_REGISTER_ID,
			bbs.NTT_SJ AS NTT_SJ,
			bbs.TEAM_NM AS TEAM_NM,
			bbs.SELECT_IMG AS SELECT_IMG,
			bbs.IMG_URL AS IMG_URL,
			comuser.USER_ID AS NTT_ID,
			comuser.USER_NM AS NTCR_NM
		FROM (
				 SELECT
					 VALT_MNGM_NO,
					 VALT_QSIT_MNNO,
					 NTT_ID,
					 BBS_ID,
					 SUM(SUM_SCR) AS TOTAL_SCORE,
					 ROUND(AVG(SUM_SCR), 2) AS AVG_SCORE,
					 COUNT(SUM_SCR) AS VALT_CNT,
					 RANK() OVER (ORDER BY SUM(SUM_SCR) DESC) AS TOTAL_SCORE_RANK,
						 RANK() OVER (ORDER BY AVG(SUM_SCR) DESC) AS AVG_SCORE_RANK
				 FROM tb_valt_sta
				 WHERE USE_AT = 'Y'
				   AND VALT_MNGM_NO = #{valtMngmNo}
				 GROUP BY VALT_MNGM_NO, VALT_QSIT_MNNO, NTT_ID, BBS_ID
			 ) r
				 LEFT JOIN LETTNBBS bbs
						   ON bbs.NTT_ID = r.NTT_ID AND bbs.BBS_ID = r.BBS_ID
				 LEFT JOIN COMVNUSERMASTER comuser
						   ON comuser.ESNTL_ID = bbs.FRST_REGISTER_ID
		ORDER BY r.TOTAL_SCORE_RANK ASC

	</select>

	<select id="selectContVoteRankListCnt" parameterType="egovframework.let.cont.vote.service.ContVoteVO" resultType="java.lang.Integer">

		SELECT
			count(1) as cnt
		FROM (
				 SELECT
					 VALT_MNGM_NO,
					 VALT_QSIT_MNNO,
					 NTT_ID,
					 BBS_ID,
					 SUM(SUM_SCR) AS TOTAL_SCORE,
					 ROUND(AVG(SUM_SCR), 2) AS AVG_SCORE,
					 COUNT(SUM_SCR) AS VALT_CNT,
					 RANK() OVER (ORDER BY SUM(SUM_SCR) DESC) AS TOTAL_SCORE_RANK,
						 RANK() OVER (ORDER BY AVG(SUM_SCR) DESC) AS AVG_SCORE_RANK
				 FROM tb_valt_sta
				 WHERE USE_AT = 'Y'
				   AND VALT_MNGM_NO = #{valtMngmNo}
				 GROUP BY VALT_MNGM_NO, VALT_QSIT_MNNO, NTT_ID, BBS_ID
			 ) r
				 LEFT JOIN LETTNBBS bbs
						   ON bbs.NTT_ID = r.NTT_ID AND bbs.BBS_ID = r.BBS_ID
				 LEFT JOIN COMVNUSERMASTER comuser
						   ON comuser.ESNTL_ID = bbs.FRST_REGISTER_ID
		ORDER BY r.TOTAL_SCORE_RANK ASC

	</select>
</mapper>